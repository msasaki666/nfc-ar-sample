<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>お守り</title>
<style>
body{font-family:sans-serif;margin:1em;text-align:center;max-width:600px;}
#charm{width:80vw;height:80vw;max-width:300px;max-height:300px;margin:auto;display:block;}
#message{font-size:1.2rem;margin-top:1em;}
button{font-size:1rem;width:100%;max-width:300px;padding:.6em;margin-top:1em;}
#toast{position:fixed;bottom:1em;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:.5em 1em;border-radius:4px;opacity:0;transition:opacity .3s;}
#toast.show{opacity:1;}
</style>
</head>
<body>
<svg id="charm" viewBox="0 0 200 200"></svg>
<p id="message"></p>
<button id="save">画像保存</button>
<div id="toast"></div>
<script>
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className='show';
  setTimeout(()=>t.className='',3000);
}
function seedFrom(str){
  let h=0;for(let i=0;i<str.length;i++){h=(h*31+str.charCodeAt(i))>>>0;}return h;
}
function rng(seed){
  return function(){seed^=seed<<13;seed^=seed>>>17;seed^=seed<<5;return (seed>>>0)/4294967296;};
}
const params=new URLSearchParams(location.search);
const token=params.get('t')||'';
if(!token){showToast('トークンがありません');}
const today=new Date().toISOString().slice(0,10);
const rand=rng(seedFrom(token+today));
const colors=['#f44336','#2196f3','#4caf50','#ff9800','#9c27b0'];
const messages=['大吉','中吉','小吉','吉','凶'];
const patterns=[
  '<circle cx="100" cy="100" r="80" fill="none" stroke="currentColor" stroke-width="10"/>',
  '<rect x="40" y="40" width="120" height="120" fill="none" stroke="currentColor" stroke-width="10"/>',
  '<polygon points="100,20 180,180 20,180" fill="none" stroke="currentColor" stroke-width="10"/>'
];
const color=colors[Math.floor(rand()*colors.length)];
const msg=messages[Math.floor(rand()*messages.length)];
const pattern=patterns[Math.floor(rand()*patterns.length)];
const svg=document.getElementById('charm');
svg.innerHTML=pattern;
svg.style.color=color;
const msgEl=document.getElementById('message');
msgEl.textContent=msg;
msgEl.style.color=color;
document.getElementById('save').onclick=()=>{
  try{
    const svgData=new XMLSerializer().serializeToString(svg);
    const blob=new Blob([svgData],{type:'image/svg+xml;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      canvas.width=200;canvas.height=200;
      const ctx=canvas.getContext('2d');
      ctx.fillStyle='#fff';
      ctx.fillRect(0,0,200,200);
      ctx.drawImage(img,0,0);
      URL.revokeObjectURL(url);
      const a=document.createElement('a');
      a.download='charm.png';
      a.href=canvas.toDataURL('image/png');
      a.click();
    };
    img.onerror=()=>showToast('画像生成に失敗しました');
    img.src=url;
  }catch(e){showToast('保存エラー: '+e.message);}
};
</script>
</body>
</html>
